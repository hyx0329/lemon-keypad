# Hi~ 你收到了一个柠檬键盘！

这份文档将介绍柠檬键盘的预装功能和修改方法。在通读这份文档后，你应该就明白如何进入安全模式、解除模拟U盘写保护，进而修改键盘功能了。

为什么默认加写保护？这不得防止杀毒软件把程序删光了。

还是建议先备份一下程序。

## 键盘硬件简介

这个设备是一个基于RP2040开发的可编程键盘。预装功能的介绍见下一节。

- 固件基于CircuitPython
    - 预载了一份功能完善的实例程序
- 硬件组件包括：
    - 树莓派RP2040微处理器（MCU，或者说CPU）
    - 6个WS2812全彩LED
    - 6个凯华BOX白轴（热插拔，可更换）
    - 1个LSM6DS3TRC 6轴姿态传感器（3轴陀螺仪、3轴加速计）
    - 16MB NOR Flash存储器（大概能放不少程序/文本）

可以把这个键盘当作一个宏键盘，实现各种特殊功能。程序采用Python编写，门槛较低，修改起来也很容易。

## 预装功能

![默认配置功能示意图](软件详细说明/默认配置功能示意图.jpg)

先说明按键顺序：USB口指向的按钮算1号，面向按钮，顺时针方向将各个按钮标记为1～6。彩色LED的编号也是如此。需要注意的是，虽然此处说明的序号从1开始，**但程序内部处理按键和LED所用的编号均从0开始**。

- 多媒体键盘，按键1到6的功能依次为：
    - 按键1：播放/暂停
    - 按键2：短按切换下一曲，长按快进
    - 按键3：音量提高
    - 按键4：静音切换，快速连按3下进入飞鼠模式
        - 飞鼠模式，单击按键1退出
        - 按键5、4、3依次为鼠标左键、中键、右键
        - 按键6、1、2依次为增加灵敏度、退出、降低灵敏度
    - 按键5：音量降低
    - 按键6：短按切换上一曲，长按快退
- 安全模式
    - 插上USB前按住除1号按钮外任意3个或以上按钮，直至所有LED显示为绿色，即进入安全模式
        - 安全模式下程序将不再运行 `boot.py`、`code.py` 中的代码，而运行 `safemode.py`。通常情况下，存放程序的模拟U盘将显示出来。
    - 安全模式为软件功能，在修改预载程序（`boot.py`和`safemode.py`）后不保证有效。
- 刷机模式
    - 按住按钮1再插上USB，可进入USB刷机模式，可以写入UF2格式的固件，一般用不到
    - 刷机模式为微处理器（RP2040）自带功能，在设备未故障时均可生效

通过修改键位图，可以按需实现多种宏功能。

- 支持多层键位图
- 支持定义点击、长按、组合键、序列按键、自定义函数等多种功能
- 放个英文字符串，能直接一口气敲出来
    - 模拟键盘采用美式布局，输出字符串其实只是自动按对应按键

## 修改功能前必读

可以先在 `code.py` 中参考示例修改键位图。亦可依次参考 `键位图示例` 文件夹中的3种键位图配置示例。预先整理好的普通键码可以在 `lib/lemon_keypad/keycode_helper.py` 中查找。按键功能类型可参阅 `软件详细说明/按键功能类型.md`，那是一个Markdown格式的普通文本文件（txt）。

`settings.toml` 是一个全局配置文件，支持字符串作为键、字符串或整数为值，其中的值可采用 `os.getenv("key_name")` 的方法获取。预装配置里提供了配置示范、记录了IMU加速度补偿值。

## 深度修改提示

在做出较复杂的修改前，建议先阅读 `boot.py`、`code.py`、`safemode.py` 程序文件，全部的键位图示例，了解键盘主程序的基本设计。

## 参考点子

- （伪）随机数生成器（也确实有办法做成真随机，参考pico-rng）
- 水平仪（用姿态传感器检测，LED指示偏移方向，这个功能已预装）
- 密码存储器
- 一键搓招，需要自己添加对gamepad的支持
- 一键脚本注入
- 普通的媒体控制器
- 某种惯导鼠标
- 打地鼠游戏机
- 功德木鱼（还是算了）
- 反过来当单个大号按键？（毕竟有姿态传感器，能做到自动切换）

## CircuitPython程序运行流程

每次启动时，CircuitPython会初始化Python解释器环境，在普通模式下执行`boot.py`，然后执行`code.py`。在因意外发生或人为切换进入到安全模式时，解释器不会执行`boot.py`和`code.py`，而是执行`safeboot.py`（如果存在）。

默认情况下，CircuitPython会提供一个USB模拟串口（Windows上的COM端口），用于数据交互/用户控制。用户打开串口（波特率115200）时可以传入Ctrl+C终止当前运行的程序。这个串口也可以被用户关闭，此处不表，参阅`boot.py`。

每次解释器环境重置时，绝大多数硬件资源将被释放，随后重置为初始状态。相当于重开了个Python解释器。

程序的默认工作目录是 `/`，即模拟U盘的根目录。解释器也会尝试从 `/lib` 加载所需python模块。

## 固件更新

细心的朋友可能会发现，本设备用的CircuitPython是给别的RP2040开发板用的。RP2040的CircuitPython固件大多互相兼容，主要是 `board` 模块暴露的引脚（GPIO）略有不同。

想升级固件，可以下载[WeAct Pico 16MB的UF2固件](https://circuitpython.org/board/weact_studio_pico_16mb/)，将设备切换至刷机模式，然后将UF2固件拖入模拟U盘中完成更新。

注意，跨大版本更新会导致程序无法运行。如需要跨大版本更新，请同时更新 `/lib` 中的CircuitPython模块，此处不详叙。程序直接依赖的模块记录在 `requirements-circuitpython.txt` 文件中。柠檬键盘预装CircuitPython 9.x，大版本为9的固件都可以兼容预装程序。

## 拆解方法

先取下键帽，再扣下顶盖，随后依次移除键盘轴、定位板、PCB主板。务必注意，PCB主板上可能有一颗M3螺丝，而部分版本的PCB与外壳之间的配合非常紧密（难拆），请小心操作，可以在卸下螺丝后用钩状工具辅助拆解。整体螺丝数量不多于1。

## 最后补充说明

想解除U盘写保护，只要进入安全模式、删除 `lock_usb_drive.txt` 文件即可。具体程序的实现在 `boot.py` 文件的末尾。

如果你确定自己完全理解了这份文档，可以考虑在模拟U盘中创建 `disable_usb_drive.txt` 文件，以隐藏模拟U盘，让这个键盘更像普通的键盘。这个功能由 `boot.py` 实现，所以要是改了可能就不管用了。**进入安全模式可以临时让这个模拟U盘变回来。**

如果魔改固件发现锁死了、无法打开串口终端、无法恢复的话，可能要进刷机模式刷清空专用固件、再重刷CircuitPython固件、将程序复制进去了。
