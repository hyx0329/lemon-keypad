# 按键功能类型说明

*本文档可能和实际代码有一定不同，提供此文档仅供功能参考，实际以代码实现为准*

在键位图中填写的按键功能分两大类

- 可直接执行的按键功能
    - 键盘、鼠标、多媒体按键
    - 用户函数
    - 字符串输出
    - 按键序列
    - 按键组合
    - 时延（一段时间什么都不做）
- 暂时不能确定的按键功能
    - 复合按键
        - 触发方式包括短按、长按、超长按，判定方法有二
            - 根据按键按下时间长度判定（复合按键抬起）
            - 根据新按键按下的时间与复合按键按下的时间差判定（复合按键没抬起，新按键按下）
        - 触发的功能包括短按、长按、键位图层切换、超长按
            - 其中长按与键位图层
    - 连击按键，按键功能由连击次数决定，触发判定的机制有三
        - 有新的不同按键在动作中按下
            - 立刻触发按键次数对应的按键功能
        - 从按下开始计算，在限时内没有再按下一次
            - 按住也算没有再按下一次
            - 触发第“按键次数”的功能
        - 按的次数太多，达到了备选键列表的长度
            - 直接触发最后一个设置的功能

## 可直接执行的按键功能

### 键盘、鼠标、多媒体按键

在键位图中，键盘、鼠标、多媒体按键都是int数字，与HID报文中的值对应，故在此称之为键码。不过为了区分三类键码，鼠标和多媒体按键均用继承自int类型的对应类来表示。

- 键盘键码：int类型，直接从键盘HID接口发出
- 鼠标键码：MouseCode(int)类型，直接从鼠标HID接口发出
- 多媒体键码：ConsumerCode(int)类型，直接从多媒体HID接口发出

### 用户函数

用户定义的函数可以作为按键功能填入键位图。这个函数可以是普通函数也可以是异步函数。程序内处理的流程如下：

1. 检查按键功能是否可以执行（callable），如是，执行，取返回值result
2. 检查返回值是否是coroutine对象，如是，await，取返回值result
3. 在日志中输出result

用户定义的函数可能会抛出异常，键盘程序将检测并在日志中记录此异常，程序不会崩溃。

用户定义函数将接受一个值为当前键盘主程序实例的参数，以便执行特殊动作。

考虑到用户函数有阻塞、死锁的可能，间接影响其它可能并发执行的函数，建议用户使用异步函数，并不时调用 `await asyncio.sleep(0)` 来切换任务。在启用看门狗计时器时，务必注意避免阻塞，及时喂狗。

在执行用户函数前后，会重置下列状态：

- 所有按键状况，全部按键将抬起
- 键位图层状态，将重置到默认层

### 字符串输出

用户可以将字符串填入键位图作为按键功能，其中的ASCII字符将转换为对应的键盘键码直接发出。

此实现不保证字符串输出时的准确性，因为键码与字符的对应关系可能因系统键盘布局产生差异。键盘程序采用了美式QWERTY键盘布局。

在字符串输出前后，所有HID输出的按键均将重置为松开状态松开。

### 按键序列

若以按键序列为按键动作，那么按键序列中的每个键将被依次按下、抬起。也可以视为一种字符串输出方式，不过设计组合键更方便。

此实现支持与自己或按键组合嵌套。

### 按键组合

若以按键组合为按键动作，键盘程序将依次连续按下各个按键，再连续依次抬起各个按键。需要注意，键盘HID报文采用6KRO格式，最多支持同时按下6个按键。

此功能适合触发组合键，如Ctrl+Alt+Del。

此实现支持与自己或按键序列嵌套。

### 时延

就是键盘暂停执行一段时间，不执行任何动作。这个动作的参数单位是秒，可以包含小数。

## 暂时不能确定的按键功能

此类按键将在未判定时记录在临时区域，在处理下一个按键下压事件之前处理完毕。最多只会出现一个功能待定的按键。

### 复合按键

此功能主要设计用于键位图层切换。此功能可以触发下列功能：

- 单击功能（tap）
- 长按功能（hold）
- 键位图层切换（layer），与长按一同触发
- 超长按（long_hold），按得足够久就触发

如果定义了tap，则当按键按下并在 `tap_term_ms` 之前抬起，将触发单击功能。

如果定义了tap，且设置 `tap_preferred` 参数为True，则当按键按下 `tap_term_ms` 时间内被其它按键打断时，将触发单击功能。

如果定义了tap，且设置 `tap_preferred` 参数为False，则当按键按下 `tap_term_ms` 时间内被其它按键打断时，将触发长按功能。

如果未定义tap，且设置了hold或layer，则当按键按下 `hold_term_ms` 时间内被其它按键打断时，将同时触发设置的长按功能和键位图层切换功能。

当设置了超长按（long_hold）且按键时间介于 `hold_term_ms` 和 `long_hold_start_ms` 之间时，若按键功能因按键抬起或其它按键按下而触发，则将不触发任何功能

在没有设置超长按（long_hold）功能时，长按功能将在长按时触发，不受 `hold_term_ms` 参数影响。

当设置了超长按（long_hold）且按键时间超过了 `long_hold_start_ms` 时间，将立刻触发超长按功能。

在只定义了tap功能时，`tap_preferred`将自动设置为True。而在没有设置tap时，`tap_preferred`将自动设置为False。

### 连击按键

一种实际功能受连击此处影响的按键功能，国外称之为Tap Dance。

连击按键定义了一组有序按键功能，按键的次数决定了执行第几个按键功能。

当超过按键间隔限时、或是被新按键打断，将触发此刻按键次数对应的功能。
当按键次数超过定义的功能数量，将触发最后一个功能。

可以在创建该按键功能时用 `tap_term_ms` 参数调整按键间隔时限。
